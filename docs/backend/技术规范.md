# 后端技术规范

> 本文档面向 AI 代码助手和开发者，定义后端开发的技术标准和约束。

## 1. 技术栈

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 语言 | Go | 1.23+ | 主开发语言 |
| HTTP 框架 | Gin | v1.9+ | 轻量级 Web 框架 |
| ORM | GORM | v1.25+ | 数据库操作 |
| 数据库 | SQLite | - | 嵌入式数据库 |
| 认证 | JWT | golang-jwt/v5 | 无状态认证 |
| 定时任务 | robfig/cron | v3 | Cron 表达式调度 |
| 配置 | Viper | v1.18+ | YAML 配置管理 |
| API 文档 | Swag | v1.16+ | Swagger 自动生成 |
| 加密 | bcrypt + AES | - | 密码哈希 + 数据加密 |
| 日志 | zap | v1.27+ | 结构化日志采集 |
| 时间处理 | dromara/carbon | v2 | 统一时间库，禁止使用标准 `time` 包 |
| 数值精度 | shopspring/decimal | - | 金额/配额计算，禁止使用 float |

## 2. 项目结构

```
backend/
├── cmd/
│   └── server/
│       └── main.go          # 程序入口，Swagger 注解
├── internal/                 # 内部包（不可被外部引用）
│   ├── config/
│   │   └── config.go        # 配置结构体 + 加载逻辑
│   ├── handler/             # HTTP 处理器（Controller 层）
│   │   ├── auth.go          # 认证相关
│   │   ├── account.go       # 账号管理
│   │   ├── cron.go          # 定时任务
│   │   └── system.go        # 系统配置
│   ├── middleware/          # 中间件
│   │   ├── auth.go          # JWT 认证
│   │   └── cors.go          # 跨域处理
│   ├── model/               # 数据模型（Entity 层）
│   │   └── models.go        # GORM 模型定义
│   ├── repository/          # 数据访问层
│   │   └── repository.go    # 数据库初始化 + 通用查询
│   ├── router/              # 路由注册
│   │   └── router.go        # 路由分组 + 中间件绑定
│   └── service/             # 业务逻辑层
│       ├── auth.go          # 认证服务
│       ├── checkin.go       # 签到核心逻辑
│       ├── cron.go          # 定时任务调度
│       └── telegram.go      # 消息推送 + 配置服务
├── pkg/                      # 可复用公共包
│   ├── logger/
│   │   └── logger.go        # zap 日志初始化
│   ├── response/
│   │   └── response.go      # 统一响应格式
│   └── utils/
│       └── crypto.go        # 加密工具函数
├── docs/                     # Swagger 生成文件（自动生成）
├── config.yaml              # 配置文件
├── Makefile                 # 构建脚本
└── go.mod                   # 依赖管理
```

## 3. 分层架构

严格遵循以下调用链路，禁止跨层调用：

```
Router → Handler → Service → Repository → Model
           ↓           ↓
       Middleware    Utils/Pkg
```

### 3.1 各层职责

| 层级 | 职责 | 禁止事项 |
|------|------|----------|
| **Handler** | 参数绑定、校验、调用 Service、返回响应 | 禁止直接操作数据库 |
| **Service** | 业务逻辑编排、事务管理 | 禁止处理 HTTP 相关 |
| **Repository** | 数据库 CRUD、复杂查询 | 禁止业务逻辑 |
| **Model** | 数据结构定义、GORM 标签 | 禁止方法逻辑 |

## 4. 编码规范

### 4.1 命名约定

```go
// 文件名：小写下划线
account_handler.go

// 结构体：大驼峰
type AccountRequest struct {}

// 函数/方法：大驼峰（导出）或小驼峰（私有）
func CreateAccount() {}
func parseToken() {}

// 常量：大驼峰或全大写下划线
const DefaultPageSize = 20
const MAX_RETRY_COUNT = 3

// 变量：小驼峰
var userCount int
```

### 4.2 错误处理

```go
// 使用 errors 包创建错误
import "errors"

var ErrUserNotFound = errors.New("用户不存在")

// Service 层返回 error
func (s *AuthService) Login(username, password string) (string, error) {
    if user == nil {
        return "", ErrUserNotFound
    }
    return token, nil
}

// Handler 层统一处理
if err != nil {
    response.Error(c, 400, err.Error())
    return
}
```

### 4.3 统一响应格式

```go
// 成功响应
response.Success(c, data)
// {"code": 0, "message": "success", "data": {...}}

// 错误响应
response.Error(c, 400, "参数错误")
// {"code": 400, "message": "参数错误", "data": null}

// 未授权
response.Unauthorized(c)
// {"code": 401, "message": "未授权", "data": null}
```

### 4.4 Swagger 注解

所有 Handler 必须添加完整 Swagger 注解：

```go
// CreateAccount 添加账号
// @Summary 添加 AnyRouter 账号
// @Tags 账号管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param request body CreateAccountRequest true "账号参数"
// @Success 200 {object} response.Response{data=model.Account}
// @Router /accounts [post]
func CreateAccount(c *gin.Context) {
    // ...
}
```

### 4.5 金额/配额计算（decimal）

**强制要求**：金额、余额、配额等涉及精度的计算必须使用 `shopspring/decimal`，禁止使用 `float32/float64`。

```go
import "github.com/shopspring/decimal"

quota := decimal.NewFromInt(537774362)
balance := quota.Div(decimal.NewFromInt(5000)).Round(2)
```

### 4.6 日志规范（zap）

**强制要求**：统一使用 `go.uber.org/zap` 记录日志，禁止使用 `fmt.Println`/`log.Printf` 等标准库输出。

- 服务启动时初始化全局 logger（`zap.ReplaceGlobals`）
- 业务代码使用 `zap.L()` 输出日志

```go
import "go.uber.org/zap"

zap.L().Info("服务启动", zap.String("addr", addr))
zap.L().Warn("解析 Session 失败", zap.Error(err))
```

## 5. 数据库规范

### 5.1 模型定义

```go
import "github.com/dromara/carbon/v2"

type User struct {
    ID        uint            `gorm:"primarykey" json:"id"`
    Username  string          `gorm:"uniqueIndex;size:50" json:"username"`
    Password  string          `gorm:"size:255" json:"-"`  // json:"-" 不返回敏感字段
    CreatedAt carbon.DateTime `json:"created_at"`
    UpdatedAt carbon.DateTime `json:"updated_at"`
    DeletedAt gorm.DeletedAt  `gorm:"index" json:"-"`
}
```

### 5.2 时间处理（carbon）

**强制要求**：所有时间相关操作必须使用 [dromara/carbon](https://github.com/dromara/carbon) 库。

**例外情况**：`time.Duration` 类型及其常量（`time.Second`、`time.Minute` 等）可继续使用，因为：
- Go 标准库接口要求（如 `http.Client.Timeout`）
- 配置解析需要（如 Viper 解析 `24h`）

```go
import "github.com/dromara/carbon/v2"

// 获取当前时间
now := carbon.Now()

// 创建 DateTime（用于 GORM 模型）
datetime := carbon.DateTime{Carbon: carbon.Now()}

// 时间格式化
now.ToDateTimeString()  // 2024-01-15 10:30:00
now.ToDateString()      // 2024-01-15
now.Format("Y-m-d H:i") // 2024-01-15 10:30

// 时间计算
now.AddDays(7)
now.SubHours(2)
now.StartOfDay()
now.EndOfMonth()

// 时间比较
now.Gt(other)   // 大于
now.Lt(other)   // 小于
now.Between(start, end)

// 从标准 time.Time 转换
carbon.CreateFromStdTime(stdTime)

// 转为标准 time.Time（用于与标准库交互）
now.StdTime()

// ✅ 允许：time.Duration 用于标准库接口
client := &http.Client{Timeout: 30 * time.Second}

// ❌ 禁止：使用 time.Now()
time.Now()  // 应改为 carbon.Now().StdTime()
```

### 5.3 查询规范

```go
// 使用链式调用
repository.DB.Where("status = ?", 1).Find(&accounts)

// 禁止字符串拼接 SQL（防注入）
// ❌ DB.Where("name = " + name)
// ✅ DB.Where("name = ?", name)

// 分页查询
DB.Offset((page - 1) * size).Limit(size).Find(&list)
```

## 6. 安全规范

### 6.1 认证

- JWT Token 有效期 24 小时
- Token 通过 `Authorization: Bearer <token>` 头传递
- 敏感接口必须使用 `middleware.Auth()` 中间件

### 6.2 加密

```go
// 密码：bcrypt 哈希
hashed, _ := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)

// 敏感数据：AES-256-GCM 加密
encrypted, _ := utils.AESEncrypt(data, config.C.AES.Key)
```

### 6.3 参数校验

```go
type LoginRequest struct {
    Username string `json:"username" binding:"required" example:"admin"`
    Password string `json:"password" binding:"required,min=6" example:"123456"`
}

// Handler 中校验
if err := c.ShouldBindJSON(&req); err != nil {
    response.Error(c, 400, "参数错误")
    return
}
```

## 7. 开发命令

```bash
# 开发模式（热重载）
make dev

# 编译
make build

# 生成 Swagger 文档
make gen-docs

# 代码格式化
make fmt

# 代码检查
make lint
```

## 8. 配置管理

配置文件 `config.yaml` 结构：

```yaml
server:
  port: 8080
  mode: debug  # debug / release

database:
  path: ./data/app.db

jwt:
  secret: <32字节Base64>
  expire: 24h

aes:
  key: <32字符十六进制>

admin:
  username: admin
  password: admin123
```

## 9. 禁止事项

1. **禁止**在 Handler 层直接操作 `repository.DB`
2. **禁止**硬编码敏感信息（密钥、密码）
3. **禁止**使用 `fmt.Println` 调试（使用日志）
4. **禁止**忽略错误返回值 `_ = someFunc()`
5. **禁止**在 Service 层使用 `*gin.Context`
6. **禁止**字符串拼接 SQL 查询
7. **禁止**返回未脱敏的敏感数据
8. **禁止**使用 `time.Now()` 获取当前时间（必须使用 `carbon.Now()`，与标准库交互时用 `.StdTime()` 转换）
